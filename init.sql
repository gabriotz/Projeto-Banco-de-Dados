-- 1. Tabelas Base (Sem chaves estrangeiras obrigatórias no início)
CREATE TABLE PESSOA (
    CPF CHAR(11) PRIMARY KEY,
    NOME VARCHAR(100) NOT NULL,
    SEXO CHAR(1),
    DATA_NASCIMENTO DATE NOT NULL,
    IDADE INT, 
    E_RUA VARCHAR(100),
    E_BAIRRO VARCHAR(50),
    E_NUMERO VARCHAR(10),
    E_CIDADE VARCHAR(50),
    CONTATO VARCHAR(20)
);

CREATE TABLE ESPECIALIDADE (
    ID_ESPECIALIDADE SERIAL PRIMARY KEY,
    NOME_ESPECIALIDADE VARCHAR(50) NOT NULL
);

CREATE TABLE CONVENIO (
    ID_CONVENIO SERIAL PRIMARY KEY,
    NOME_CONVENIO VARCHAR(100) NOT NULL
);

CREATE TABLE DEPARTAMENTO (
    ID_DEPARTAMENTO SERIAL PRIMARY KEY,
    NOME_DEPARTAMENTO VARCHAR(50) NOT NULL
    -- O Gerente será adicionado depois via ALTER TABLE
);

-- 2. Hierarquia de Pessoas (Generalização/Especialização)

-- Nível 1: Paciente e Funcionário
CREATE TABLE PACIENTE (
    CPF_PACIENTE CHAR(11) PRIMARY KEY,
    NUMERO_PRONTUARIO VARCHAR(20) UNIQUE NOT NULL,
    FOREIGN KEY (CPF_PACIENTE) REFERENCES PESSOA(CPF)
);

CREATE TABLE FUNCIONARIO (
    CPF_FUNCIONARIO CHAR(11) PRIMARY KEY,
    SALARIO NUMERIC(10, 2),
    DATA_ADMISSAO DATE,
    ID_DEPARTAMENTO INT,
    ID_SUPERVISOR CHAR(11),
    FOREIGN KEY (CPF_FUNCIONARIO) REFERENCES PESSOA(CPF),
    FOREIGN KEY (ID_DEPARTAMENTO) REFERENCES DEPARTAMENTO(ID_DEPARTAMENTO),
    FOREIGN KEY (ID_SUPERVISOR) REFERENCES FUNCIONARIO(CPF_FUNCIONARIO)
);

-- Nível 2: Tipos de Funcionários
CREATE TABLE MEDICO (
    CPF_MEDICO CHAR(11) PRIMARY KEY,
    CRM VARCHAR(20) UNIQUE NOT NULL,
    FOREIGN KEY (CPF_MEDICO) REFERENCES FUNCIONARIO(CPF_FUNCIONARIO)
);

CREATE TABLE ENFERMEIRO (
    CPF_ENFERMEIRO CHAR(11) PRIMARY KEY,
    COREN VARCHAR(20) UNIQUE NOT NULL,
    FOREIGN KEY (CPF_ENFERMEIRO) REFERENCES FUNCIONARIO(CPF_FUNCIONARIO)
);

CREATE TABLE ADMINISTRATIVO (
    CPF_ADM CHAR(11) PRIMARY KEY,
    CARGO_ADMINISTRATIVO VARCHAR(50),
    FOREIGN KEY (CPF_ADM) REFERENCES FUNCIONARIO(CPF_FUNCIONARIO)
);

-- 3. Resolução da Dependência Circular (Departamento <-> Médico)
ALTER TABLE DEPARTAMENTO 
ADD COLUMN CPF_GERENTE CHAR(11),
ADD CONSTRAINT FK_DEPT_GERENTE FOREIGN KEY (CPF_GERENTE) REFERENCES MEDICO(CPF_MEDICO);

-- 4. Tabelas Operacionais e Financeiras
CREATE TABLE PAGADOR (
    ID_PAGADOR SERIAL PRIMARY KEY,
    NOME_PAGADOR VARCHAR(100),
    TIPO_PAGADOR VARCHAR(20), -- 'Paciente', 'Convenio', 'Responsavel'
    ID_CONVENIO INT,
    CPF_PACIENTE CHAR(11),
    FOREIGN KEY (ID_CONVENIO) REFERENCES CONVENIO(ID_CONVENIO),
    FOREIGN KEY (CPF_PACIENTE) REFERENCES PACIENTE(CPF_PACIENTE)
);

CREATE TABLE PROCEDIMENTO (
    ID_PROCEDIMENTO SERIAL PRIMARY KEY,
    TIPO_PROCEDIMENTO VARCHAR(50),
    CUSTO NUMERIC(10, 2),
    DATA_PROCEDIMENTO TIMESTAMP,
    ID_PAGADOR INT,
    CPF_PACIENTE CHAR(11) NOT NULL,
    FOREIGN KEY (ID_PAGADOR) REFERENCES PAGADOR(ID_PAGADOR),
    FOREIGN KEY (CPF_PACIENTE) REFERENCES PACIENTE(CPF_PACIENTE)
);

CREATE TABLE CIRURGIA (
    ID_CIRURGIA SERIAL PRIMARY KEY,
    NOME_CIRURGIA VARCHAR(100),
    ID_ESPECIALIDADE INT,
    FOREIGN KEY (ID_ESPECIALIDADE) REFERENCES ESPECIALIDADE(ID_ESPECIALIDADE)
);

-- 5. Tabelas Associativas (N:M)
CREATE TABLE MEDICO_ESPECIALIDADE (
    CPF_MEDICO CHAR(11),
    ID_ESPECIALIDADE INT,
    PRIMARY KEY (CPF_MEDICO, ID_ESPECIALIDADE),
    FOREIGN KEY (CPF_MEDICO) REFERENCES MEDICO(CPF_MEDICO),
    FOREIGN KEY (ID_ESPECIALIDADE) REFERENCES ESPECIALIDADE(ID_ESPECIALIDADE)
);

CREATE TABLE MEDICO_REALIZA_PROCEDIMENTO (
    CPF_MEDICO CHAR(11),
    ID_PROCEDIMENTO INT,
    PRIMARY KEY (CPF_MEDICO, ID_PROCEDIMENTO),
    FOREIGN KEY (CPF_MEDICO) REFERENCES MEDICO(CPF_MEDICO),
    FOREIGN KEY (ID_PROCEDIMENTO) REFERENCES PROCEDIMENTO(ID_PROCEDIMENTO)
);

CREATE TABLE ENFERM_ACOMPANHA_PROCEDIMENTO (
    CPF_ENFERMEIRO CHAR(11),
    ID_PROCEDIMENTO INT,
    PRIMARY KEY (CPF_ENFERMEIRO, ID_PROCEDIMENTO),
    FOREIGN KEY (CPF_ENFERMEIRO) REFERENCES ENFERMEIRO(CPF_ENFERMEIRO),
    FOREIGN KEY (ID_PROCEDIMENTO) REFERENCES PROCEDIMENTO(ID_PROCEDIMENTO)
);

CREATE TABLE ADMIN_AGENDA_PROCEDIMENTO (
    CPF_ADM CHAR(11),
    ID_PROCEDIMENTO INT,
    PRIMARY KEY (CPF_ADM, ID_PROCEDIMENTO),
    FOREIGN KEY (CPF_ADM) REFERENCES ADMINISTRATIVO(CPF_ADM),
    FOREIGN KEY (ID_PROCEDIMENTO) REFERENCES PROCEDIMENTO(ID_PROCEDIMENTO)
);

CREATE TABLE PESSOA_RESPONSAVEL_PACIENTE (
    CPF_RESPONSAVEL CHAR(11),
    CPF_PACIENTE CHAR(11),
    PRIMARY KEY (CPF_RESPONSAVEL, CPF_PACIENTE),
    FOREIGN KEY (CPF_RESPONSAVEL) REFERENCES PESSOA(CPF),
    FOREIGN KEY (CPF_PACIENTE) REFERENCES PACIENTE(CPF_PACIENTE)
);


-- ==================================================================================
-- PARTE 2: INSERÇÃO DE DADOS (DML)
-- ==================================================================================

-- GRUPO A: DADOS AUXILIARES (Convênios, Especialidades e Deptos Iniciais)
INSERT INTO ESPECIALIDADE (NOME_ESPECIALIDADE) VALUES 
('Cardiologia'), ('Ortopedia'), ('Pediatria'), ('Neurologia'), ('Dermatologia'), ('Cirurgia Geral');

INSERT INTO CONVENIO (NOME_CONVENIO) VALUES 
('Unimed'), ('Bradesco Saúde'), ('SulAmérica');

INSERT INTO DEPARTAMENTO (NOME_DEPARTAMENTO) VALUES 
('Cardiologia'), ('Ortopedia'), ('Administração Hospitalar'), ('Neurologia');


-- GRUPO B: EQUIPE MÉDICA E FUNCIONÁRIOS (Cria Pessoa -> Func -> Especialização)

-- 1. Dr. João Silva (Cardiologista e Gerente da Cardio)
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('11111111111', 'Dr. João Silva', 'M', '1980-05-20', 45, 'Recife');

INSERT INTO FUNCIONARIO (CPF_FUNCIONARIO, SALARIO, DATA_ADMISSAO, ID_DEPARTAMENTO) 
VALUES ('11111111111', 15000.00, '2015-02-01', 1); -- Depto 1: Cardio

INSERT INTO MEDICO (CPF_MEDICO, CRM) VALUES ('11111111111', 'CRM-PE-1234');
INSERT INTO MEDICO_ESPECIALIDADE (CPF_MEDICO, ID_ESPECIALIDADE) VALUES ('11111111111', 1); -- Cardio

-- 2. Dr. Roberto House (Neurologista, Cirurgião e Gerente da Neuro)
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('55555555555', 'Dr. Roberto House', 'M', '1975-10-10', 50, 'Recife');

INSERT INTO FUNCIONARIO (CPF_FUNCIONARIO, SALARIO, DATA_ADMISSAO, ID_DEPARTAMENTO) 
VALUES ('55555555555', 22000.00, '2010-01-15', 4); -- Depto 4: Neuro

INSERT INTO MEDICO (CPF_MEDICO, CRM) VALUES ('55555555555', 'CRM-PE-9999');
INSERT INTO MEDICO_ESPECIALIDADE (CPF_MEDICO, ID_ESPECIALIDADE) VALUES ('55555555555', 4), ('55555555555', 6); -- Neuro e Cirurgia

-- 3. Enfermeira Maria Souza (Cardio)
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('22222222222', 'Enf. Maria Souza', 'F', '1990-08-15', 35, 'Olinda');

INSERT INTO FUNCIONARIO (CPF_FUNCIONARIO, SALARIO, DATA_ADMISSAO, ID_DEPARTAMENTO) 
VALUES ('22222222222', 5000.00, '2018-06-10', 1);

INSERT INTO ENFERMEIRO (CPF_ENFERMEIRO, COREN) VALUES ('22222222222', 'COREN-PE-5678');

-- 4. Enfermeira Joana Darc (Neuro)
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('66666666666', 'Enf. Joana Darc', 'F', '1985-12-25', 40, 'Olinda');

INSERT INTO FUNCIONARIO (CPF_FUNCIONARIO, SALARIO, DATA_ADMISSAO, ID_DEPARTAMENTO) 
VALUES ('66666666666', 4500.00, '2019-03-10', 4);

INSERT INTO ENFERMEIRO (CPF_ENFERMEIRO, COREN) VALUES ('66666666666', 'COREN-PE-8888');

-- 5. Ana Adm (Recepcionista)
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('44444444444', 'Ana Adm', 'F', '1995-03-30', 30, 'Recife');

INSERT INTO FUNCIONARIO (CPF_FUNCIONARIO, SALARIO, DATA_ADMISSAO, ID_DEPARTAMENTO) 
VALUES ('44444444444', 3000.00, '2020-01-20', 3); -- Depto 3: Adm

INSERT INTO ADMINISTRATIVO (CPF_ADM, CARGO_ADMINISTRATIVO) VALUES ('44444444444', 'Recepcionista');

-- 6. Diretora Ana Paula
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('10101010101', 'Ana Paula Diretora', 'F', '1980-02-02', 45, 'Recife');

INSERT INTO FUNCIONARIO (CPF_FUNCIONARIO, SALARIO, DATA_ADMISSAO, ID_DEPARTAMENTO) 
VALUES ('10101010101', 12000.00, '2015-01-01', 3);

INSERT INTO ADMINISTRATIVO (CPF_ADM, CARGO_ADMINISTRATIVO) VALUES ('10101010101', 'Diretora Geral');


-- GRUPO C: ATUALIZAÇÃO ESTRUTURAL (Definir Gerentes)
-- Agora que os médicos existem, podemos torná-los chefes
UPDATE DEPARTAMENTO SET CPF_GERENTE = '11111111111' WHERE ID_DEPARTAMENTO = 1; -- João manda na Cardio
UPDATE DEPARTAMENTO SET CPF_GERENTE = '55555555555' WHERE ID_DEPARTAMENTO = 4; -- House manda na Neuro


-- GRUPO D: PACIENTES E RESPONSÁVEIS

-- 1. Carlos (Adulto comum)
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('33333333333', 'Carlos Paciente', 'M', '2000-01-10', 25, 'Jaboatão');
INSERT INTO PACIENTE (CPF_PACIENTE, NUMERO_PRONTUARIO) VALUES ('33333333333', 'PRONT-2025-001');

-- 2. Pedrinho (Criança) + Mãe Julia (Responsável)
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('77777777777', 'Pedrinho Silva', 'M', '2018-05-05', 7, 'Jaboatão');
INSERT INTO PACIENTE (CPF_PACIENTE, NUMERO_PRONTUARIO) VALUES ('77777777777', 'PRONT-PED-001');

INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('88888888888', 'Julia Silva (Mãe)', 'F', '1990-01-01', 35, 'Jaboatão');
INSERT INTO PESSOA_RESPONSAVEL_PACIENTE (CPF_RESPONSAVEL, CPF_PACIENTE) VALUES ('88888888888', '77777777777');

-- 3. Dona Benta (Idosa)
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('99999999999', 'Dona Benta', 'F', '1950-07-20', 75, 'Recife');
INSERT INTO PACIENTE (CPF_PACIENTE, NUMERO_PRONTUARIO) VALUES ('99999999999', 'PRONT-GER-002');

-- 4. José Acidentado (Emergência)
INSERT INTO PESSOA (CPF, NOME, SEXO, DATA_NASCIMENTO, IDADE, E_CIDADE) 
VALUES ('12121212121', 'José Acidentado', 'M', '1995-05-05', 30, 'Olinda');
INSERT INTO PACIENTE (CPF_PACIENTE, NUMERO_PRONTUARIO) VALUES ('12121212121', 'PRONT-EMERG-99');


-- GRUPO E: CENÁRIOS CLÍNICOS E PROCEDIMENTOS

-- Cenário 1: Consulta Simples (Carlos vai ao Cardio)
INSERT INTO PAGADOR (NOME_PAGADOR, TIPO_PAGADOR, CPF_PACIENTE) 
VALUES ('Carlos Paciente', 'Paciente', '33333333333'); -- ID 1

INSERT INTO PROCEDIMENTO (TIPO_PROCEDIMENTO, CUSTO, DATA_PROCEDIMENTO, ID_PAGADOR, CPF_PACIENTE) 
VALUES ('Consulta Cardiologista', 300.00, '2025-11-23 14:00:00', 1, '33333333333'); -- ID 1

INSERT INTO MEDICO_REALIZA_PROCEDIMENTO (CPF_MEDICO, ID_PROCEDIMENTO) VALUES ('11111111111', 1);

-- Cenário 2: Cirurgia Complexa (Dona Benta opera catarata com Dr. House, Pago por Convênio)
INSERT INTO PAGADOR (NOME_PAGADOR, TIPO_PAGADOR, ID_CONVENIO, CPF_PACIENTE) 
VALUES ('Unimed Seguros', 'Convenio', 1, '99999999999'); -- ID 2

INSERT INTO PROCEDIMENTO (TIPO_PROCEDIMENTO, CUSTO, DATA_PROCEDIMENTO, ID_PAGADOR, CPF_PACIENTE) 
VALUES ('Cirurgia de Catarata', 4500.00, '2025-11-25 08:00:00', 2, '99999999999'); -- ID 2

INSERT INTO CIRURGIA (NOME_CIRURGIA, ID_ESPECIALIDADE) VALUES ('Facoemulsificação', 6);

INSERT INTO MEDICO_REALIZA_PROCEDIMENTO (CPF_MEDICO, ID_PROCEDIMENTO) VALUES ('55555555555', 2);
INSERT INTO ENFERM_ACOMPANHA_PROCEDIMENTO (CPF_ENFERMEIRO, ID_PROCEDIMENTO) VALUES ('66666666666', 2);
INSERT INTO ADMIN_AGENDA_PROCEDIMENTO (CPF_ADM, ID_PROCEDIMENTO) VALUES ('44444444444', 2); -- Ana agendou

-- Cenário 3: Pediatria (Mãe paga consulta do Pedrinho)
INSERT INTO PAGADOR (NOME_PAGADOR, TIPO_PAGADOR, CPF_PACIENTE) 
VALUES ('Julia Silva', 'Responsavel', '77777777777'); -- ID 3

INSERT INTO PROCEDIMENTO (TIPO_PROCEDIMENTO, CUSTO, DATA_PROCEDIMENTO, ID_PAGADOR, CPF_PACIENTE) 
VALUES ('Consulta Pediátrica', 250.00, '2025-11-26 10:00:00', 3, '77777777777'); -- ID 3

-- Cenário 4: Exame Caro (Carlos faz Ressonância pelo Convênio)
INSERT INTO PAGADOR (NOME_PAGADOR, TIPO_PAGADOR, ID_CONVENIO, CPF_PACIENTE) 
VALUES ('Unimed - Exame Carlos', 'Convenio', 1, '33333333333'); -- ID 4

INSERT INTO PROCEDIMENTO (TIPO_PROCEDIMENTO, CUSTO, DATA_PROCEDIMENTO, ID_PAGADOR, CPF_PACIENTE) 
VALUES ('Ressonância Magnética', 800.00, '2025-11-27 15:30:00', 4, '33333333333'); -- ID 4

INSERT INTO MEDICO_REALIZA_PROCEDIMENTO (CPF_MEDICO, ID_PROCEDIMENTO) VALUES ('11111111111', 4); -- Cardio pediu

-- Cenário 5: Emergência (José chega acidentado)
INSERT INTO PAGADOR (NOME_PAGADOR, TIPO_PAGADOR, CPF_PACIENTE) 
VALUES ('José Acidentado', 'Paciente', '12121212121'); -- ID 5

INSERT INTO PROCEDIMENTO (TIPO_PROCEDIMENTO, CUSTO, DATA_PROCEDIMENTO, ID_PAGADOR, CPF_PACIENTE) 
VALUES ('Sutura de Emergência', 150.00, '2025-11-23 23:00:00', 5, '12121212121'); -- ID 5

INSERT INTO MEDICO_REALIZA_PROCEDIMENTO (CPF_MEDICO, ID_PROCEDIMENTO) VALUES ('11111111111', 5); -- Dr. João estava no plantão
INSERT INTO ENFERM_ACOMPANHA_PROCEDIMENTO (CPF_ENFERMEIRO, ID_PROCEDIMENTO) VALUES ('22222222222', 5), ('66666666666', 5); -- Duas enfermeiras ajudaram